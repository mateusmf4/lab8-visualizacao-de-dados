<!DOCTYPE html>
<html lang="pt-br"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab8 - Grupo D</title>

    <style>
      body {
        font-family: 'Roboto', sans-serif;
        background-color: #f4f6f9;
        color: #333;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      .dashboard-header {
        background-color: #2c3e50;
        color: white;
        padding: 30px;
        text-align: left;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .dashboard-title {
        margin: 0;
        font-size: 36px;
        font-weight: 700;
      }
      .lead {
        font-size: 20px;
        color: #ecf0f1;
        margin-top: 10px;
      }
      #chart-header {
        display: flex;
        align-items: left;
        justify-content: space-between;
        width: 100%;
        max-width: 800px;
      }
      #chart-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 40px;
      }
      #chart {
        width: 100%;
        max-width: 800px;
        height: 500px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-top: 30px;
      }
      #back-button {
        display: none;
        margin-top: 20px;
        padding: 12px;
        font-size: 16px;
        background-color: #3498db;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s ease;
      }
      #back-button:hover {
        background-color: #2980b9;
      }
      .card {
        margin: 40px auto;
        border: none;
        overflow: hidden;
        background-color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .card-header {
        background-color: #34495e;
        color: white;
        padding: 20px;
        font-size: 18px;
        font-weight: 600;
      }
      .card-body {
        padding: 30px;
        font-size: 16px;
        color: #7f8c8d;
        line-height: 1.6;
      }
      .header-info {
        padding: 20px 50px;
        background-color: #a4dceb;
      }

      .botao-estresse {
        border: 0;
        cursor: pointer;
        width: 100%;

        --_color: rgb(75, 167, 144);

        --_actual-color: var(--_color);
        background: var(--_actual-color);
        border: 2px solid color-mix(in oklch, var(--_actual-color), black 5%);

        transition: all 100ms;
      }

      .botao-estresse:hover {
        --_actual-color: color-mix(in oklch, var(--_color), white 20%);
      }
    </style>
  </head>
  <body>
    <div class="header-info">
      <table style="width: 100%; border: 0">
        <tbody><tr>
          <td style="text-align: left; vertical-align: top">
            <table style="border: 0">
              <tbody><tr>
                <td style="width: 70px">
                  <img src="https://maxmcz.github.io/visualizacao-de-dados_exemplo/UFCG_logo_png.png" alt="Brasão UFCG" style="margin-top: 5px; height: 62px">
                </td>
                <td>
                  <div style="line-height: 1.4">
                    <div>
                      <strong>UNIVERSIDADE FEDERAL DE CAMPINA GRANDE - UFCG</strong>
                    </div>
                    <div>
                      CENTRO DE ENGENHARIA ELÉTRICA E INFORMÁTICA - CEEI
                    </div>
                    <div>UNIDADE ACADÊMICA DE SISTEMAS E COMPUTAÇÃO - UASC</div>
                  </div>
                </td>
              </tr>
            </tbody></table>
          </td>

          <td style="text-align: right; vertical-align: top">
            <div>Disciplina: Visualização de Dados</div>
            <div>Professor: Maxwell Guimarães de Oliveira</div>
            <div>Período: 2025.1</div>
          </td>
        </tr>
      </tbody></table>
    </div>

    <div id="header">
      <h2 style="text-align: center">
        Projeto de Visualização Interativa de Dados
      </h2>
      <h4 style="text-align: center">
        <u>Grupo D</u>: Daniele Oliveira, Filipe Luiz, João Victor Cosme, Maria Helena Satyro, Mateus Medeiros
      </h4>
      <h2 style="text-align: center">
        <span style="
          font-family: 'Lucida Sans Unicode', 'Lucida Grande', sans-serif;
        "><strong>Tipos de estresses e seus fatores em estudantes universitários (de 17 a 22 anos)</strong></span>
      </h2>
      <p style="text-align: justify; padding: 10px 50px 10px 50px">
        Os dados foram coletados através de 843 estudantes universitários, de 17 a 22 anos, em relação as suas experiencias com o estresse e seus impactos.
        Os dados coletados consistem em varias perguntas em forma de questionario, com respostas de 1 (Discordo totalmente) a 5 (Concordo totalmente).

        <b style="text-decoration: underline; text-transform: uppercase; color: red; font-style: italic;">(breve resumo das historias visualizadas)</b>
      </p>
    </div>

    <div style="max-width: 1500px; height: 800px; margin-inline: auto; display: flex; position: relative; padding-inline: 10px;">
      <div id="div-controls" style="width: 130px; display: flex; flex-direction: row; align-items: stretch; margin-block: 65px;">
        <button type="button" id="btn-voltar" style="writing-mode: sideways-lr;">
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 4v7a4 4 0 0 1-4 4H4"/><path d="m9 10-5 5 5 5"/></svg>
          Anterior
        </button>
        <div style="display: flex; flex-direction: column; flex: 1; align-items: stretch; width: 100%;">
          <button id="btn-stress-2" type="button" class="botao-estresse" style="flex: 8;">Sem estresse</button>
          <button id="btn-stress-1" type="button" class="botao-estresse" style="flex: 86;">Estresse<br>Positivo</button>
          <button id="btn-stress-0" type="button" class="botao-estresse" style="flex: 11;">Estresse<br>Negativo</button>
        </div>
      </div>
      <div id="container" style="flex: 1;"></div>
    </div>

    <div id="footer" style="height: 2%; margin-top: 50px">
      <p style="text-align: justify; padding: 20px 50px 0px 50px">
        <b>Dicas para interagir com a visualização</b>:
      </p>
      <ul style="padding: 0px 50px 10px 75px;">
        <li>Clique na area de interesse para ver mais detalhes sobre aquele tipo de estresse</li>
        <li>Clique em cada categoria para ver todas as perguntas relevantes</li>
      </ul>
    </div>

  <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

  <script type="text/javascript">
    var dom = document.getElementById('container');
    var myChart = echarts.init(dom, null, {
      renderer: 'canvas',
      useDirtyRect: false
    });
    var app = {};

    function median(arr) {
      arr.sort();
      if (arr.length % 2 == 0) {
        let m = arr.length / 2;
        return (arr[m - 1] + arr[m]) / 2;
      } else {
        return arr[Math.floor(arr.length / 2)];
      }
    }

    function average(arr) {
      return arr.reduce((acc, x) => acc + x, 0) / arr.length;
    }

    function arrMin(arr) {
      return arr.reduce((a, v) => (v < a ? v : a));
    }

    function arrMax(arr) {
      return arr.reduce((a, v) => (v > a ? v : a));
    }

    const filterOut = ['Gender', 'Age', 'Which type of stress do you primarily experience?'];
    const stresses = ["DIS", "EUS", "NOS"];
    const stressNames = ["Distresse", "Eustresse", "Sem estresse"];
    const cores = ["#e790ab", "#8eda90", "#849fe8"]
    const categorias = {
      "AES": "Acadêmico",
      "ESI": "Emocional",
      "SRF": "Social",
      "PHI": "Físico"
    };
    const categorias2 = {
      "AES": "acadêmica",
      "ESI": "emocional",
      "SRF": "social",
      "PHI": "física"
    };

    const percDistress = [];
    const percEustress = [];
    const percNostress = [];

    let currentChart = 0;
    let currentStress = 0;
    let currentCategory = "AES";

    function updateControls() {
      for (let i = 0; i <= 2; ++i) {
        const elem = document.getElementById('btn-stress-' + i);
        elem.style.setProperty('--_color', cores[i]);
        if (i === currentStress) {
          elem.style.opacity = 1.0;
        } else {
          elem.style.opacity = 0.5;
        }
      }
      document.getElementById('btn-voltar').style.opacity = currentChart === 0 ? 0 : 1;
      document.getElementById('div-controls').style.display = currentChart === 0 ? 'none' : 'flex';
      myChart.resize();
    }
    updateControls();

    document.getElementById('btn-voltar').addEventListener('click', () => {
      if (currentChart === 1) {
        stackedChart();
      } else if (currentChart === 2) {
        barsMedia(currentStress);
      }
    });

    for (let i = 0; i <= 2; ++i) {
      document.getElementById('btn-stress-' + i).addEventListener('click', e => {
        if (currentChart === 0) {
          barsMedia(i);
        } else if (currentChart === 1) {
          barsMedia(i);
        } else if (currentChart === 2) {
          barsCategoria(i, currentCategory);
        }
      })
    }

    myChart.showLoading();

    let dados;
    fetch("./dados.json").then(r => r.json()).catch(e => alert("Erro ao carregar dados!")).then(d => {
      dados = d;

      for (let i = 17; i <= 24; ++i) {
        let idx = i - 17;
        let a = dados.EUS.AES.filter(x => x.Age === i).length;
        let b = dados.DIS.AES.filter(x => x.Age === i).length;
        let c = dados.NOS.AES.filter(x => x.Age === i).length;
        let total = a + b + c;
        percEustress.push(a / total);
        percDistress.push(b / total);
        percNostress.push(c / total);
      }
      // 23 = (22 + 24) / 2
      percEustress[6] = (percEustress[5] + percEustress[7]) / 2;
      percDistress[6] = (percDistress[5] + percDistress[7]) / 2;
      percNostress[6] = (percNostress[5] + percNostress[7]) / 2;

      myChart.hideLoading();
      stackedChart();
      // barsMedia(0);
      // barsCategoria(1, "AES")
    });

    function stackedChart() {
      currentChart = 0;
      updateControls();

      let option = {
        title: {
          text: "Tipos de estresse em estudantes universitários",
          subtext: "(Dica: clique para ver mais detalhes)",
          left: "center"
        },
        tooltip: {
          trigger: 'axis',
          valueFormatter: (value) => `${(value * 100).toFixed(2)}%`,
          axisPointer: {
            label: {
              formatter: ({value}) => `${value} anos`
            },
          },
        },
        grid: {
          right: '15%',
        },
        legend: {
          data: ["Sem estresse", "Estresse positivo", "Estresse negativo"],
          orient: 'vertical',
          icon: 'rect',
          right: 0,
          top: 56,
          selectedMode: false,
          textStyle: {
            fontSize: 16,
          },
          formatter: name => {
            if (name === 'Estresse positivo') {
              return "Estresse positivo:\nque motiva e melhora\no desempenho"
            } else if (name === 'Estresse negativo') {
              return "Estresse negativo:\nque causa ansiedade\ne afeta o bem-estar"
            } else {
              return "Pouco ou quase\nnenhum sinal\nde estresse"
            }
          }
        },
        xAxis: [
          {
            name: 'Idade',
            nameLocation: 'middle',
            nameTextStyle: {
              fontSize: 16,
            },
            type: 'category',
            boundaryGap: false,
            // data: [17, 18, 19, 20, 21, 22, "23*", 24]
            data: [17, 18, 19, 20, 21, 22],
          }
        ],
        yAxis: [
          {
            name: 'Percentual\nde respostas',
            nameTextStyle: {
              fontSize: 16,
            },
            type: 'value',
            axisLabel: {
              formatter: (x) => `${(x * 100).toFixed(0)}%`
            }
          }
        ],
        series: [
          {
            name: 'Estresse negativo',
            type: 'line',
            stack: 'Total',
            smooth: true,
            emphasis: {
              focus: 'self'
            },
            data: percDistress,
            animation: false,
            areaStyle: {
              color: cores[0],
            },
            itemStyle: {
              color: cores[0],
            },
          },
          {
            name: 'Estresse positivo',
            type: 'line',
            stack: 'Total',
            smooth: true,
            emphasis: {
              focus: 'self'
            },
            data: percEustress,
            animation: false,
            areaStyle: {
              color: cores[1],
            },
            itemStyle: {
              color: cores[1],
            },
          },
          {
            name: 'Sem estresse',
            type: 'line',
            stack: 'Total',
            smooth: true,
            emphasis: {
              focus: 'self'
            },
            data: percNostress,
            animation: false,
            areaStyle: {
              color: cores[2],
            },
            itemStyle: {
              color: cores[2],
            },
          },
        ],
        graphic: [
          {
            type: 'text',
            z: 5,
            left: 'center',
            top: '50%',   // ajusta posição vertical
            style: {
              text: 'Estresse Positivo',
              fill: '#2c3e50',
              fontSize: 20,
              fontWeight: 'bold',
              textAlign: 'center'
            }
          },
          {
            type: 'text',
            z: 5,
            right: '20%',
            bottom: '12%',
            style: {
              text: 'Estresse Negativo',
              fill: '#2c3e50',
              fontSize: 20,
              fontWeight: 'bold',
              textAlign: 'right'
            }
          },
          {
            type: 'text',
            z: 5,
            left: '20%',
            top: '10%',
            style: {
              text: 'Sem Estresse',
              fill: '#2c3e50',
              fontSize: 20,
              fontWeight: 'bold',
              textAlign: 'left'
            }
          }
        ]
      };
      myChart.setOption(option, true);
    }

    function barsMedia(stressIndex) {
      let prevChart = currentChart;
      currentChart = 1;
      currentStress = stressIndex;
      updateControls();

      const stress = stresses[stressIndex];
      const values = Object.keys(categorias).map((category, i) => {
        const keys = Object.keys(dados[stress][category][0]).filter(x => !filterOut.includes(x));
        const values = keys.map(key => dados[stress][category].map(x => x[key]));
        // console.log(values.flat());
        // return values.flat();
        const avgs = values.map(x => average(x));
        // return average(values.flat());
        // return medians;
        return {
          name: categorias[category],
          value: [i, arrMin(avgs), arrMax(avgs), average(avgs)]
        }
      });

      let option = {
        title: {
          text: "Intervalo das respostas médias, por categoria",
          left: "center",
          subtext: "Concordância as perguntas tende a indicar estresse negativo\n(Dica: clique para ver mais detalhes)"
        },
        yAxis: {
          type: 'category',
          data: Object.values(categorias),
          show: false,
        },
        xAxis: {
          name: 'Escala Likert',
          nameLocation: 'middle',
          nameGap: 35,
          nameTextStyle: {
            fontStyle: 'italic',
            fontSize: 16,
          },
          type: 'value',
          min: 1,
          max: 5,
          axisLabel: {
            formatter: x => ["Discordo totalmente", "Discordo parcialmente", "Indiferente", "Concordo parcialmente", "Concordo totalmente"][x - 1],
            fontSize: 16,
          }
        },
        series: [
          // {
          //   data: values.map(({value: x}) => (x[1] + x[2]) / 2),
          //   type: 'scatter',
          //   symbolSize: 30,
          //   label: {
          //     show: true,
          //     formatter: ({name}) => name,
          //     position: 'right',
          //   },
          //   itemStyle: {
          //     color: cores[stressIndex]
          //   },
          // }
          {
            data: values,
            type: 'custom',
            itemStyle: {
              color: cores[stressIndex],
            },
            renderItem: (params, api) => {
              var categoryIndex = api.value(0);
              var start = api.coord([api.value(1), categoryIndex]);
              var end = api.coord([api.value(2), categoryIndex]);
              var height = api.size([0, 1])[1] * 0.015;
              const middle = api.coord([api.value(3), categoryIndex])
              var rectShape = echarts.graphic.clipRectByRect(
                {
                  x: start[0],
                  y: start[1] - height / 2,
                  width: end[0] - start[0],
                  height: height
                },
                {
                  x: params.coordSys.x,
                  y: params.coordSys.y,
                  width: params.coordSys.width,
                  height: params.coordSys.height
                }
              );
              return rectShape && {
                type: 'group',
                children: [
                  {
                    type: 'rect',
                    shape: rectShape,
                    // style: api.style(),
                    style: {
                      opacity: 0.5,
                    },
                    transition: ['shape']
                  },
                  {
                    type: 'circle',
                    x: middle[0],
                    y: middle[1],
                    shape: {
                      r: 15,
                    },
                    style: api.style(),
                    textContent: {
                      type: 'text',
                      style: {
                        text: Object.values(categorias)[categoryIndex],
                        fontSize: 20,
                        stroke: 'rgba(255 255 255 / 50%)',
                        lineWidth: 2,
                        y: '-25'
                      }
                    }
                  }
                ]
              };
            }
          }
        ],
        tooltip: {
          // trigger: 'axis',
          axisPointer: {
            type: 'shadow',
            shadowStyle: {
              color: 'rgba(150, 150, 200, 0.1)'
            }
          },
          formatter: (params) => {
            return `${params.marker} ${params.name}<br>
            <b>Menor média</b> - ${params.data.value[1].toFixed(1)}<br>
            <b>Maior média</b> - ${params.data.value[2].toFixed(1)}<br>
            <b>Média geral</b> - ${params.data.value[3].toFixed(1)}
            `;
          }
        },
      };
      myChart.setOption(option, prevChart === 0);
    }

    function barsCategoria(stressIndex, category) {
      currentChart = 2;
      currentStress = stressIndex;
      currentCategory = category;
      updateControls();

      const stress = stresses[stressIndex];
      let keys = Object.keys(dados[stress][category][0]).filter(x => !filterOut.includes(x));
      const rawValues = keys.map(key => dados[stress][category].map(x => x[key]));
      let medians = rawValues.map(x => average(x));

      // ordena pelo valor
      let pairs = keys.map((key, i) => [key, medians[i]]).sort((a, b) => a[1] - b[1]);
      keys = pairs.map(([k, _]) => k);
      let values = pairs.map(([_, v]) => v);

      let option = {
        title: {
          text: `Média de cada pergunta da categoria "${categorias[category]}"`,
          subtext: "Concordância as perguntas tende a indicar estresse negativo",
          left: "center"
        },
        yAxis: {
          type: 'category',
          data: keys,
          offset: 50,
          show: false,
        },
        xAxis: {
          name: 'Escala Likert',
          nameLocation: 'middle',
          nameGap: 35,
          nameTextStyle: {
            fontStyle: 'italic',
            fontSize: 16,
          },
          type: 'value',
          min: 1,
          max: 5,
          axisLabel: {
            formatter: x => ["Discordo totalmente", "Discordo parcialmente", "Indiferente", "Concordo parcialmente", "Concordo totalmente"][x - 1],
            fontSize: 16,
          }
        },
        series: [
          {
            data: values,
            type: 'scatter',
            symbolSize: 30,
            label: {
              show: true,
              formatter: ({name}) => name,
              position: stressIndex === 0 ? 'left' : 'right',
              fontSize: 16,
            },
            itemStyle: {
              color: cores[stressIndex]
            }
          }
        ],
      };
      myChart.setOption(option, true);
    }

    myChart.getZr().on('click', (params) => {
      if (currentChart !== 0) return;
      if (!params.target) return;
      let keys = Object.keys(params.target).filter(key => key.includes('__ec_inner_')).filter(key => params.target[key].seriesIndex !== undefined);
      if (!keys.length) return;
      barsMedia(params.target[keys[0]].seriesIndex);
    });

    myChart.on('click', (params) => {
      if (currentChart !== 1) return;
      barsCategoria(currentStress, Object.keys(categorias)[params.dataIndex]);
    });

    window.addEventListener('resize', myChart.resize);
  </script>

</body></html>